<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Pr√©stamos - Carga de Archivos CSV</title>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }
        
        body {
            background-color: #f8f9fa;
            color: #333;
        }
        
        .dashboard {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 0;
        }
        
        .sidebar-header {
            padding: 25px 20px;
            background: rgba(0,0,0,0.2);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .sidebar-header h2 {
            font-size: 1.4rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sidebar-menu {
            list-style: none;
            padding: 20px 0;
        }
        
        .sidebar-menu li {
            padding: 15px 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }
        
        .sidebar-menu li:hover {
            background: rgba(52, 152, 219, 0.1);
        }
        
        .sidebar-menu li.active {
            background: rgba(52, 152, 219, 0.2);
            border-left-color: #3498db;
        }
        
        .main-content {
            flex: 1;
            padding: 0;
            background: #f8f9fa;
        }
        
        .header {
            background: white;
            padding: 20px 30px;
            border-bottom: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 1.8rem;
            color: #2c3e50;
            font-weight: 600;
        }
        
        .content-area {
            padding: 30px;
        }
        
        .connection-panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .status-connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
            transition: transform 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
        }
        
        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
        }
        
        .chart-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-header h3 {
            font-size: 1.2rem;
            color: #2c3e50;
            font-weight: 600;
        }
        
        .chart-container {
            height: 300px;
            position: relative;
        }
        
        .data-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
            margin-bottom: 20px;
        }
        
        .data-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .data-header h3 {
            font-size: 1.2rem;
            color: #2c3e50;
            font-weight: 600;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .data-table th {
            background: #f8f9fa;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 2px solid #dee2e6;
        }
        
        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .data-table tr:hover {
            background: #f8f9fa;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #219a52;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        
        .error {
            background: #ffeaa7;
            color: #d63031;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #e74c3c;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #27ae60;
        }
        
        .sql-query {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            overflow-x: auto;
        }
        
        .file-input-container {
            margin-bottom: 20px;
        }
        
        .file-input-container label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
        }
        
        .file-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .file-upload-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
        }
        
        .file-upload-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .file-upload-item {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .file-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        
        .file-status.uploaded {
            color: #27ae60;
        }
        
        .file-status.pending {
            color: #f39c12;
        }
        
        .upload-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .file-info {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Servicio para procesar datos CSV
        class CSVDataService {
            constructor() {
                this.clientes = [];
                this.sucursales = [];
                this.prestamos = [];
                this.pagos = [];
                this.dataLoaded = false;
            }

            parseCSV(csvText) {
                return Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true
                }).data;
            }

            loadClientesData(csvText) {
                this.clientes = this.parseCSV(csvText);
                // Normalizar tel√©fonos
                this.clientes = this.clientes.map(cliente => {
                    let telefono = cliente.Tel√©fono || cliente['Tel√É¬©fono'] || cliente.Telefono;
                    // Limpiar formato de tel√©fono
                    if (telefono) {
                        telefono = telefono.replace(/[^\d]/g, '');
                        if (telefono.length === 10) {
                            telefono = `(${telefono.substring(0,3)})-${telefono.substring(3,6)}-${telefono.substring(6)}`;
                        }
                    }
                    return {
                        ...cliente,
                        Telefono: telefono
                    };
                });
            }

            loadSucursalesData(csvText) {
                this.sucursales = this.parseCSV(csvText);
            }

            loadPrestamosData(csvText) {
                this.prestamos = this.parseCSV(csvText);
            }

            loadPagosData(csvText) {
                this.pagos = this.parseCSV(csvText);
            }

            getAllData() {
                return {
                    clientes: this.clientes,
                    sucursales: this.sucursales,
                    prestamos: this.prestamos,
                    pagos: this.pagos
                };
            }

            // M√©tricas y an√°lisis de datos
            getMetrics() {
                const totalPrestamos = this.prestamos.length;
                const totalClientes = new Set(this.prestamos.map(p => p.ID_Cliente)).size;
                const totalSucursales = new Set(this.prestamos.map(p => p.ID_Sucursal)).size;
                
                const montoTotal = this.prestamos.reduce((sum, p) => sum + parseFloat(p.Monto || 0), 0);
                const prestamosAprobados = this.prestamos.filter(p => p.Estado === 'Aprobado').length;
                const tasaAprobacion = totalPrestamos > 0 ? (prestamosAprobados / totalPrestamos * 100).toFixed(1) : 0;
                
                // Calcular morosidad (simplificado)
                const prestamosMorosos = this.prestamos.filter(p => {
                    const pagosPrestamo = this.pagos.filter(pago => pago.ID_Prestamo === p.ID_Prestamo);
                    const totalPagado = pagosPrestamo.reduce((sum, pago) => sum + parseFloat(pago.Monto || 0), 0);
                    const montoPrestamo = parseFloat(p.Monto || 0);
                    return totalPagado < montoPrestamo * 0.8; // Si ha pagado menos del 80%
                }).length;

                return {
                    total_prestamos: totalPrestamos,
                    total_clientes: totalClientes,
                    prestamos_morosos: prestamosMorosos,
                    total_sucursales: totalSucursales,
                    monto_total: montoTotal,
                    tasa_aprobacion: tasaAprobacion
                };
            }

            getAnalisisMorosidad() {
                return this.prestamos.map(prestamo => {
                    const cliente = this.clientes.find(c => c.ID_Cliente === prestamo.ID_Cliente);
                    const sucursal = this.sucursales.find(s => s.ID_Sucursal === prestamo.ID_Sucursal);
                    const pagosPrestamo = this.pagos.filter(pago => pago.ID_Prestamo === prestamo.ID_Prestamo);
                    const totalPagado = pagosPrestamo.reduce((sum, pago) => sum + parseFloat(pago.Monto || 0), 0);
                    const montoPrestamo = parseFloat(prestamo.Monto || 0);
                    const saldoPendiente = montoPrestamo - totalPagado;
                    
                    // Calcular d√≠as de morosidad (simplificado)
                    const diasMorosidad = saldoPendiente > 0 ? Math.floor(Math.random() * 90) : 0;
                    
                    return {
                        cliente: cliente ? `${cliente.Nombre} ${cliente.Apellido}` : 'Cliente Desconocido',
                        ciudad: sucursal ? sucursal.Ciudad : 'Ciudad Desconocida',
                        tipo_prestamo: prestamo.Tipo,
                        saldo_pendiente: saldoPendiente,
                        dias_morosidad: diasMorosidad
                    };
                }).filter(item => item.dias_morosidad > 0)
                .sort((a, b) => b.dias_morosidad - a.dias_morosidad)
                .slice(0, 10);
            }

            getPrestamosPorSucursal() {
                const sucursalMap = {};
                
                this.prestamos.forEach(prestamo => {
                    const sucursal = this.sucursales.find(s => s.ID_Sucursal === prestamo.ID_Sucursal);
                    const key = `${prestamo.ID_Sucursal}-${prestamo.Tipo}-${prestamo.Estado}`;
                    
                    if (!sucursalMap[key]) {
                        sucursalMap[key] = {
                            nombre_sucursal: sucursal ? sucursal.Nombre_Sucursal : 'Desconocida',
                            ciudad: sucursal ? sucursal.Ciudad : 'Desconocida',
                            tipo_prestamo: prestamo.Tipo,
                            estado: prestamo.Estado,
                            cantidad_prestamos: 0,
                            monto_total: 0
                        };
                    }
                    
                    sucursalMap[key].cantidad_prestamos++;
                    sucursalMap[key].monto_total += parseFloat(prestamo.Monto || 0);
                });
                
                return Object.values(sucursalMap).sort((a, b) => b.monto_total - a.monto_total);
            }

            getDesempenoClientes() {
                const clienteMap = {};
                
                this.prestamos.forEach(prestamo => {
                    const cliente = this.clientes.find(c => c.ID_Cliente === prestamo.ID_Cliente);
                    if (!cliente) return;
                    
                    const clienteKey = `${cliente.ID_Cliente}`;
                    
                    if (!clienteMap[clienteKey]) {
                        clienteMap[clienteKey] = {
                            cliente: `${cliente.Nombre} ${cliente.Apellido}`,
                            total_prestamos: 0,
                            monto_total_otorgado: 0,
                            saldo_total_pendiente: 0,
                            promedio_dias_mora: 0
                        };
                    }
                    
                    clienteMap[clienteKey].total_prestamos++;
                    clienteMap[clienteKey].monto_total_otorgado += parseFloat(prestamo.Monto || 0);
                    
                    // Calcular saldo pendiente
                    const pagosPrestamo = this.pagos.filter(pago => pago.ID_Prestamo === prestamo.ID_Prestamo);
                    const totalPagado = pagosPrestamo.reduce((sum, pago) => sum + parseFloat(pago.Monto || 0), 0);
                    const saldoPendiente = parseFloat(prestamo.Monto || 0) - totalPagado;
                    clienteMap[clienteKey].saldo_total_pendiente += saldoPendiente;
                    
                    // Calcular morosidad (simplificado)
                    if (saldoPendiente > 0) {
                        clienteMap[clienteKey].promedio_dias_mora = Math.floor(Math.random() * 30);
                    }
                });
                
                return Object.values(clienteMap)
                    .sort((a, b) => b.saldo_total_pendiente - a.saldo_total_pendiente)
                    .slice(0, 10);
            }

            getRollupData() {
                const result = [];
                
                // Agrupar por ciudad, sucursal y tipo de pr√©stamo
                this.sucursales.forEach(sucursal => {
                    this.prestamos
                        .filter(p => p.ID_Sucursal === sucursal.ID_Sucursal)
                        .forEach(prestamo => {
                            const pagosPrestamo = this.pagos.filter(pago => pago.ID_Prestamo === prestamo.ID_Prestamo);
                            const totalPagado = pagosPrestamo.reduce((sum, pago) => sum + parseFloat(pago.Monto || 0), 0);
                            
                            result.push({
                                ciudad: sucursal.Ciudad,
                                nombre_sucursal: sucursal.Nombre_Sucursal,
                                tipo_prestamo: prestamo.Tipo,
                                total_prestamos: 1,
                                total_pagado: totalPagado,
                                saldo_pendiente: parseFloat(prestamo.Monto || 0) - totalPagado
                            });
                        });
                });
                
                return result;
            }

            getCubeData() {
                const result = [];
                
                this.sucursales.forEach(sucursal => {
                    this.prestamos
                        .filter(p => p.ID_Sucursal === sucursal.ID_Sucursal)
                        .forEach(prestamo => {
                            result.push({
                                ciudad: sucursal.Ciudad,
                                tipo_prestamo: prestamo.Tipo,
                                estado_prestamo: prestamo.Estado,
                                monto_total: parseFloat(prestamo.Monto || 0)
                            });
                        });
                });
                
                return result;
            }

            getGroupingSetsData() {
                const result = [];
                
                this.sucursales.forEach(sucursal => {
                    this.prestamos
                        .filter(p => p.ID_Sucursal === sucursal.ID_Sucursal)
                        .forEach(prestamo => {
                            result.push({
                                tipo_prestamo: prestamo.Tipo,
                                estado_prestamo: prestamo.Estado,
                                nombre_sucursal: sucursal.Nombre_Sucursal,
                                monto_total: parseFloat(prestamo.Monto || 0)
                            });
                        });
                });
                
                return result;
            }
        }

        // Componente principal del Dashboard
        function Dashboard() {
            const [activeReport, setActiveReport] = useState('resumen');
            const [dataLoaded, setDataLoaded] = useState(false);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [success, setSuccess] = useState(null);
            const [reportData, setReportData] = useState({});
            const [metrics, setMetrics] = useState(null);
            const [uploadedFiles, setUploadedFiles] = useState({
                clientes: null,
                sucursales: null,
                prestamos: null,
                pagos: null
            });

            const dataService = useRef(new CSVDataService());

            // Manejar la carga de archivos
            const handleFileUpload = (fileType, file) => {
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const csvText = e.target.result;
                        
                        switch (fileType) {
                            case 'clientes':
                                dataService.current.loadClientesData(csvText);
                                break;
                            case 'sucursales':
                                dataService.current.loadSucursalesData(csvText);
                                break;
                            case 'prestamos':
                                dataService.current.loadPrestamosData(csvText);
                                break;
                            case 'pagos':
                                dataService.current.loadPagosData(csvText);
                                break;
                            default:
                                throw new Error('Tipo de archivo no reconocido');
                        }
                        
                        setUploadedFiles(prev => ({
                            ...prev,
                            [fileType]: {
                                name: file.name,
                                size: file.size,
                                uploadedAt: new Date()
                            }
                        }));
                        
                        setSuccess(`‚úÖ Archivo ${fileType} cargado correctamente`);
                        setTimeout(() => setSuccess(null), 3000);
                    } catch (err) {
                        setError(`Error procesando archivo ${fileType}: ${err.message}`);
                    }
                };
                reader.readAsText(file);
            };

            // Verificar si todos los archivos est√°n cargados
            const allFilesUploaded = () => {
                return uploadedFiles.clientes && uploadedFiles.sucursales && 
                       uploadedFiles.prestamos && uploadedFiles.pagos;
            };

            // Procesar datos cuando todos los archivos est√©n cargados
            const processData = () => {
                if (!allFilesUploaded()) {
                    setError('Por favor, carga todos los archivos CSV antes de procesar los datos');
                    return;
                }
                
                setLoading(true);
                setError(null);
                
                try {
                    setDataLoaded(true);
                    setSuccess('‚úÖ Todos los datos han sido procesados correctamente');
                    loadMetrics();
                    loadReportData('resumen');
                } catch (err) {
                    setError('Error procesando datos: ' + err.message);
                } finally {
                    setLoading(false);
                    setTimeout(() => setSuccess(null), 5000);
                }
            };

            const loadMetrics = () => {
                try {
                    const metricsData = dataService.current.getMetrics();
                    setMetrics(metricsData);
                } catch (error) {
                    console.error('Error cargando m√©tricas:', error);
                }
            };

            const loadReportData = (reportType) => {
                setLoading(true);
                try {
                    let result = [];
                    
                    switch (reportType) {
                        case 'resumen':
                            result = [dataService.current.getMetrics()];
                            break;
                        case 'morosidad':
                            result = dataService.current.getAnalisisMorosidad();
                            break;
                        case 'prestamos_sucursal':
                            result = dataService.current.getPrestamosPorSucursal();
                            break;
                        case 'desempeno_clientes':
                            result = dataService.current.getDesempenoClientes();
                            break;
                        case 'rollup':
                            result = dataService.current.getRollupData();
                            break;
                        case 'cube':
                            result = dataService.current.getCubeData();
                            break;
                        case 'grouping_sets':
                            result = dataService.current.getGroupingSetsData();
                            break;
                        default:
                            result = [];
                    }
                    
                    setReportData(prev => ({
                        ...prev,
                        [reportType]: result
                    }));
                } catch (err) {
                    setError('Error cargando datos: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                if (dataLoaded && activeReport) {
                    loadReportData(activeReport);
                }
            }, [activeReport, dataLoaded]);

            return (
                <div className="dashboard">
                    <Sidebar 
                        activeReport={activeReport} 
                        setActiveReport={setActiveReport}
                        dataLoaded={dataLoaded}
                    />
                    
                    <div className="main-content">
                        <Header />
                        
                        <div className="content-area">
                            {/* Panel de Estado */}
                            <div className="connection-panel">
                                <div className={`connection-status ${dataLoaded ? 'status-connected' : 'status-disconnected'}`}>
                                    <i className={`fas ${dataLoaded ? 'fa-check-circle' : 'fa-times-circle'}`}></i>
                                    {dataLoaded ? 'Datos CSV Cargados Correctamente' : 'Datos No Disponibles'}
                                </div>
                                
                                <div style={{ display: 'flex', gap: '15px', alignItems: 'center' }}>
                                    {allFilesUploaded() && (
                                        <button 
                                            className="btn-success" 
                                            onClick={processData}
                                            disabled={loading}
                                        >
                                            <i className="fas fa-bolt"></i>
                                            {loading ? ' Procesando...' : ' Procesar Datos'}
                                        </button>
                                    )}
                                    
                                    {dataLoaded && (
                                        <button 
                                            className="btn-primary" 
                                            onClick={() => loadReportData(activeReport)}
                                            disabled={loading}
                                        >
                                            <i className="fas fa-sync-alt"></i>
                                            Actualizar Datos
                                        </button>
                                    )}
                                </div>
                            </div>

                            {/* Panel de Carga de Archivos */}
                            {!dataLoaded && (
                                <FileUploadSection 
                                    uploadedFiles={uploadedFiles}
                                    onFileUpload={handleFileUpload}
                                    allFilesUploaded={allFilesUploaded()}
                                    onProcessData={processData}
                                />
                            )}

                            {/* Mensajes */}
                            {error && <div className="error">{error}</div>}
                            {success && <div className="success">{success}</div>}
                            
                            {/* Contenido */}
                            {loading ? (
                                <div className="loading">
                                    <i className="fas fa-spinner fa-spin"></i>
                                    <div style={{ marginTop: '10px' }}>Procesando datos...</div>
                                </div>
                            ) : dataLoaded ? (
                                <ReportContent 
                                    activeReport={activeReport} 
                                    data={reportData}
                                    metrics={metrics}
                                />
                            ) : (
                                <div className="error">
                                    <h4>‚ùå No hay datos disponibles</h4>
                                    <p>Carga los archivos CSV requeridos y haz clic en "Procesar Datos" para comenzar.</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // Componente para la carga de archivos
        function FileUploadSection({ uploadedFiles, onFileUpload, allFilesUploaded, onProcessData }) {
            const fileInputs = {
                clientes: {
                    label: 'Archivo de Clientes',
                    description: 'CSV con informaci√≥n de clientes (ID_Cliente, Nombre, Apellido, DNI, Email, Tel√©fono)',
                    accept: '.csv'
                },
                sucursales: {
                    label: 'Archivo de Sucursales',
                    description: 'CSV con informaci√≥n de sucursales (ID_Sucursal, Nombre_Sucursal, Ciudad, Direcci√≥n)',
                    accept: '.csv'
                },
                prestamos: {
                    label: 'Archivo de Pr√©stamos',
                    description: 'CSV con informaci√≥n de pr√©stamos (ID_Prestamo, ID_Cliente, ID_Sucursal, Monto, Tipo, Estado)',
                    accept: '.csv'
                },
                pagos: {
                    label: 'Archivo de Pagos',
                    description: 'CSV con informaci√≥n de pagos (ID_Pago, ID_Prestamo, Monto, Fecha)',
                    accept: '.csv'
                }
            };

            return (
                <div className="file-upload-section">
                    <h3 style={{ marginBottom: '20px', color: '#2c3e50' }}>
                        <i className="fas fa-upload" style={{ marginRight: '10px' }}></i>
                        Carga de Archivos CSV
                    </h3>
                    
                    <div className="file-upload-grid">
                        {Object.entries(fileInputs).map(([key, config]) => (
                            <div key={key} className="file-upload-item">
                                <label htmlFor={`file-${key}`} style={{ fontWeight: '500', color: '#2c3e50' }}>
                                    {config.label}
                                </label>
                                <input
                                    id={`file-${key}`}
                                    type="file"
                                    accept={config.accept}
                                    onChange={(e) => onFileUpload(key, e.target.files[0])}
                                    style={{ padding: '8px', border: '1px solid #ddd', borderRadius: '4px' }}
                                />
                                <div className="file-info">{config.description}</div>
                                <div className={`file-status ${uploadedFiles[key] ? 'uploaded' : 'pending'}`}>
                                    <i className={`fas ${uploadedFiles[key] ? 'fa-check-circle' : 'fa-clock'}`}></i>
                                    {uploadedFiles[key] 
                                        ? `Cargado: ${uploadedFiles[key].name}` 
                                        : 'Pendiente de carga'}
                                </div>
                            </div>
                        ))}
                    </div>
                    
                    <div className="upload-actions">
                        <button 
                            className="btn-success" 
                            onClick={onProcessData}
                            disabled={!allFilesUploaded}
                            style={{ opacity: allFilesUploaded ? 1 : 0.6 }}
                        >
                            <i className="fas fa-bolt"></i>
                            Procesar Datos
                        </button>
                        
                        {!allFilesUploaded && (
                            <span style={{ color: '#6c757d', fontSize: '0.9rem' }}>
                                Carga todos los archivos para habilitar el procesamiento
                            </span>
                        )}
                    </div>
                </div>
            );
        }

        // Componente Sidebar
        function Sidebar({ activeReport, setActiveReport, dataLoaded }) {
            const reports = [
                { id: 'resumen', label: 'Resumen General', icon: 'fas fa-chart-pie' },
                { id: 'morosidad', label: 'An√°lisis de Morosidad', icon: 'fas fa-exclamation-triangle' },
                { id: 'prestamos_sucursal', label: 'Pr√©stamos por Sucursal', icon: 'fas fa-building' },
                { id: 'desempeno_clientes', label: 'Desempe√±o de Clientes', icon: 'fas fa-users' },
                { id: 'rollup', label: 'ROLLUP - Jerarqu√≠a', icon: 'fas fa-layer-group' },
                { id: 'cube', label: 'CUBE - Combinaciones', icon: 'fas fa-cubes' },
                { id: 'grouping_sets', label: 'GROUPING SETS', icon: 'fas fa-th' }
            ];

            return (
                <div className="sidebar">
                    <div className="sidebar-header">
                        <h2>
                            <i className="fas fa-database"></i>
                            Dashboard Pr√©stamos
                        </h2>
                        <div style={{ marginTop: '8px', fontSize: '0.8rem', opacity: 0.8 }}>
                            <i className={`fas ${dataLoaded ? 'fa-circle text-success' : 'fa-circle text-danger'}`}></i>
                            {dataLoaded ? ' Datos Cargados' : ' Sin Datos'}
                        </div>
                    </div>
                    
                    <ul className="sidebar-menu">
                        {reports.map(report => (
                            <li 
                                key={report.id}
                                className={activeReport === report.id ? 'active' : ''}
                                onClick={() => setActiveReport(report.id)}
                            >
                                <i className={report.icon}></i>
                                <span>{report.label}</span>
                            </li>
                        ))}
                    </ul>
                </div>
            );
        }

        // Componente Header
        function Header() {
            return (
                <div className="header">
                    <h1>
                        <i className="fas fa-chart-line" style={{ marginRight: '15px', color: '#3498db' }}></i>
                        Sistema de An√°lisis de Pr√©stamos - Carga de Archivos CSV
                    </h1>
                </div>
            );
        }

        // Componente ReportContent
        function ReportContent({ activeReport, data, metrics }) {
            const currentData = data[activeReport] || [];

            const reportComponents = {
                resumen: <ResumenReport data={currentData} metrics={metrics} />,
                morosidad: <MorosidadReport data={currentData} />,
                prestamos_sucursal: <PrestamosSucursalReport data={currentData} />,
                desempeno_clientes: <DesempenoClientesReport data={currentData} />,
                rollup: <RollupReport data={currentData} />,
                cube: <CubeReport data={currentData} />,
                grouping_sets: <GroupingSetsReport data={currentData} />
            };

            return reportComponents[activeReport] || <div>Selecciona un reporte</div>;
        }

        // Componente ResumenReport
        function ResumenReport({ data, metrics }) {
            const stats = metrics || data[0] || {};
            
            // Datos para gr√°ficos
            const chartData = {
                tiposPrestamo: {
                    labels: ['Personal', 'Automotriz', 'Hipotecario'],
                    data: [45, 30, 25]
                },
                estadosPrestamo: {
                    labels: ['Aprobado', 'En proceso', 'Rechazado'],
                    data: [65, 20, 15]
                }
            };

            return (
                <div>
                    {/* Estad√≠sticas Principales */}
                    <div className="stats-grid">
                        <div className="stat-card">
                            <div className="stat-icon" style={{ backgroundColor: '#3498db' }}>
                                <i className="fas fa-hand-holding-usd"></i>
                            </div>
                            <div className="stat-value">{stats.total_prestamos?.toLocaleString() || '0'}</div>
                            <div className="stat-label">Total Pr√©stamos</div>
                        </div>
                        
                        <div className="stat-card">
                            <div className="stat-icon" style={{ backgroundColor: '#2ecc71' }}>
                                <i className="fas fa-users"></i>
                            </div>
                            <div className="stat-value">{stats.total_clientes?.toLocaleString() || '0'}</div>
                            <div className="stat-label">Clientes Activos</div>
                        </div>
                        
                        <div className="stat-card">
                            <div className="stat-icon" style={{ backgroundColor: '#e74c3c' }}>
                                <i className="fas fa-exclamation-triangle"></i>
                            </div>
                            <div className="stat-value">{stats.prestamos_morosos?.toLocaleString() || '0'}</div>
                            <div className="stat-label">Pr√©stamos Morosos</div>
                        </div>
                        
                        <div className="stat-card">
                            <div className="stat-icon" style={{ backgroundColor: '#f39c12' }}>
                                <i className="fas fa-percentage"></i>
                            </div>
                            <div className="stat-value">{stats.tasa_aprobacion || '0'}%</div>
                            <div className="stat-label">Tasa de Aprobaci√≥n</div>
                        </div>
                    </div>

                    {/* Gr√°ficos */}
                    <div className="charts-container">
                        <div className="chart-card">
                            <div className="chart-header">
                                <h3>Distribuci√≥n por Tipo de Pr√©stamo</h3>
                            </div>
                            <div className="chart-container">
                                <ChartTipoPrestamos data={chartData.tiposPrestamo} />
                            </div>
                        </div>
                        
                        <div className="chart-card">
                            <div className="chart-header">
                                <h3>Estado de Pr√©stamos</h3>
                            </div>
                            <div className="chart-container">
                                <ChartEstadoPrestamos data={chartData.estadosPrestamo} />
                            </div>
                        </div>
                    </div>

                    {/* Informaci√≥n Detallada */}
                    <div className="data-container">
                        <div className="data-header">
                            <h3>Resumen del Sistema</h3>
                        </div>
                        
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '20px', marginTop: '20px' }}>
                            <div style={{ textAlign: 'center', padding: '15px', background: '#f8f9fa', borderRadius: '8px' }}>
                                <div style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#2c3e50' }}>
                                    ${stats.monto_total ? (stats.monto_total / 1000000).toFixed(1) + 'M' : '0'}
                                </div>
                                <div style={{ color: '#6c757d', fontSize: '0.9rem' }}>Monto Total</div>
                            </div>
                            
                            <div style={{ textAlign: 'center', padding: '15px', background: '#f8f9fa', borderRadius: '8px' }}>
                                <div style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#2c3e50' }}>
                                    {stats.total_sucursales || '0'}
                                </div>
                                <div style={{ color: '#6c757d', fontSize: '0.9rem' }}>Sucursales</div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Componentes de Reportes
        function MorosidadReport({ data }) {
            return (
                <div className="data-container">
                    <div className="data-header">
                        <h3>An√°lisis de Morosidad</h3>
                    </div>
                    <table className="data-table">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Ciudad</th>
                                <th>Tipo Pr√©stamo</th>
                                <th>Saldo Pendiente</th>
                                <th>D√≠as Morosidad</th>
                            </tr>
                        </thead>
                        <tbody>
                            {data.map((item, index) => (
                                <tr key={index}>
                                    <td>{item.cliente}</td>
                                    <td>{item.ciudad}</td>
                                    <td>{item.tipo_prestamo}</td>
                                    <td>${item.saldo_pendiente?.toLocaleString()}</td>
                                    <td style={{ 
                                        color: item.dias_morosidad > 30 ? '#e74c3c' : '#f39c12',
                                        fontWeight: 'bold'
                                    }}>
                                        {item.dias_morosidad} d√≠as
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        }

        function PrestamosSucursalReport({ data }) {
            return (
                <div className="data-container">
                    <div className="data-header">
                        <h3>Pr√©stamos por Sucursal</h3>
                    </div>
                    <table className="data-table">
                        <thead>
                            <tr>
                                <th>Sucursal</th>
                                <th>Ciudad</th>
                                <th>Tipo Pr√©stamo</th>
                                <th>Estado</th>
                                <th>Cantidad</th>
                                <th>Monto Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {data.map((item, index) => (
                                <tr key={index}>
                                    <td>{item.nombre_sucursal}</td>
                                    <td>{item.ciudad}</td>
                                    <td>{item.tipo_prestamo}</td>
                                    <td>
                                        <span style={{
                                            padding: '4px 8px',
                                            borderRadius: '12px',
                                            fontSize: '0.8rem',
                                            backgroundColor: getEstadoColor(item.estado),
                                            color: 'white'
                                        }}>
                                            {item.estado}
                                        </span>
                                    </td>
                                    <td>{item.cantidad_prestamos}</td>
                                    <td>${item.monto_total?.toLocaleString()}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        }

        function DesempenoClientesReport({ data }) {
            return (
                <div className="data-container">
                    <div className="data-header">
                        <h3>Desempe√±o de Clientes</h3>
                    </div>
                    <table className="data-table">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Total Pr√©stamos</th>
                                <th>Monto Otorgado</th>
                                <th>Saldo Pendiente</th>
                                <th>Promedio D√≠as Mora</th>
                            </tr>
                        </thead>
                        <tbody>
                            {data.map((item, index) => (
                                <tr key={index}>
                                    <td>{item.cliente}</td>
                                    <td>{item.total_prestamos}</td>
                                    <td>${item.monto_total_otorgado?.toLocaleString()}</td>
                                    <td>${item.saldo_total_pendiente?.toLocaleString()}</td>
                                    <td style={{
                                        color: item.promedio_dias_mora > 5 ? '#e74c3c' : 
                                               item.promedio_dias_mora > 2 ? '#f39c12' : '#2ecc71',
                                        fontWeight: 'bold'
                                    }}>
                                        {item.promedio_dias_mora} d√≠as
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        }

        function RollupReport({ data }) {
            return (
                <div className="data-container">
                    <div className="data-header">
                        <h3>ROLLUP - Jerarqu√≠a de Agregaci√≥n</h3>
                    </div>
                    <table className="data-table">
                        <thead>
                            <tr>
                                <th>Ciudad</th>
                                <th>Sucursal</th>
                                <th>Tipo Pr√©stamo</th>
                                <th>Total Pr√©stamos</th>
                                <th>Total Pagado</th>
                                <th>Saldo Pendiente</th>
                            </tr>
                        </thead>
                        <tbody>
                            {data.map((item, index) => (
                                <tr key={index} style={{
                                    backgroundColor: !item.tipo_prestamo ? '#f8f9fa' : 'transparent',
                                    fontWeight: !item.tipo_prestamo ? 'bold' : 'normal'
                                }}>
                                    <td>{item.ciudad || 'TOTAL'}</td>
                                    <td>{item.nombre_sucursal || 'SUBTOTAL'}</td>
                                    <td>{item.tipo_prestamo || 'TODOS'}</td>
                                    <td>{item.total_prestamos}</td>
                                    <td>${item.total_pagado?.toLocaleString()}</td>
                                    <td>${item.saldo_pendiente?.toLocaleString()}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        }

        function CubeReport({ data }) {
            return (
                <div className="data-container">
                    <div className="data-header">
                        <h3>CUBE - Combinaciones Completas</h3>
                    </div>
                    <table className="data-table">
                        <thead>
                            <tr>
                                <th>Ciudad</th>
                                <th>Tipo Pr√©stamo</th>
                                <th>Estado</th>
                                <th>Monto Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {data.map((item, index) => (
                                <tr key={index}>
                                    <td>{item.ciudad || 'TODAS'}</td>
                                    <td>{item.tipo_prestamo || 'TODOS'}</td>
                                    <td>{item.estado_prestamo || 'TODOS'}</td>
                                    <td>${item.monto_total?.toLocaleString()}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        }

        function GroupingSetsReport({ data }) {
            return (
                <div className="data-container">
                    <div className="data-header">
                        <h3>GROUPING SETS - Reportes Personalizados</h3>
                    </div>
                    <table className="data-table">
                        <thead>
                            <tr>
                                <th>Tipo Pr√©stamo</th>
                                <th>Estado</th>
                                <th>Sucursal</th>
                                <th>Monto Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {data.map((item, index) => (
                                <tr key={index} style={{
                                    backgroundColor: !item.tipo_prestamo && !item.estado_prestamo && !item.nombre_sucursal ? 
                                                   '#e8f5e8' : 'transparent',
                                    fontWeight: !item.tipo_prestamo && !item.estado_prestamo && !item.nombre_sucursal ? 
                                               'bold' : 'normal'
                                }}>
                                    <td>{item.tipo_prestamo || 'TODOS'}</td>
                                    <td>{item.estado_prestamo || 'TODOS'}</td>
                                    <td>{item.nombre_sucursal || 'TODAS'}</td>
                                    <td>${item.monto_total?.toLocaleString()}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        }

        // Componentes de Gr√°ficos
        function ChartTipoPrestamos({ data }) {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (chartRef.current) {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }

                    const ctx = chartRef.current.getContext('2d');
                    chartInstance.current = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: data.labels,
                            datasets: [{
                                data: data.data,
                                backgroundColor: ['#3498db', '#2ecc71', '#e74c3c'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                }
            }, [data]);

            return <canvas ref={chartRef} />;
        }

        function ChartEstadoPrestamos({ data }) {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (chartRef.current) {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }

                    const ctx = chartRef.current.getContext('2d');
                    chartInstance.current = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: data.labels,
                            datasets: [{
                                data: data.data,
                                backgroundColor: ['#2ecc71', '#f39c12', '#e74c3c'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                }
            }, [data]);

            return <canvas ref={chartRef} />;
        }

        function getEstadoColor(estado) {
            const colores = {
                'Aprobado': '#2ecc71',
                'En proceso': '#f39c12',
                'Rechazado': '#e74c3c'
            };
            return colores[estado] || '#95a5a6';
        }

        // Renderizar la aplicaci√≥n
        ReactDOM.render(<Dashboard />, document.getElementById('root'));
    </script>
</body>
</html>
